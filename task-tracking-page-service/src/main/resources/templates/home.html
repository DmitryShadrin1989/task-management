<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>List of available boards</title>
    <style type="text/css">
        .boards {
            border: 1px solid steelblue;
            width: 300px;
            border-collapse: collapse;
        }

        .boards tr td, th {
            padding: 5px;
            border: 1px solid steelblue;
        }

        .boards td:last-child, td:first-child {
            width: 50px;
        }
    </style>
</head>

<body onload="uploadDataToPage()">

<h2>Home page</h2>

<div class="currentUser" id="currentUser">Greetings to you </div>
<br>

<h3>List of available boards:</h3>

<div class="commandsBoards">
    <a th:href="@{/task-management/board/new}" href="boardConfiguration.html" type="button">
        <button>New board</button>
    </a>
</div>

<br>

<table class="boards" id="boards">
    <thead>
    <tr>
        <th>â„–</th>
        <th>Owner</th>
        <th>Board Name</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<script>
    const gateway_host = "http://localhost:8080";

    let token;
    const currentUser = document.getElementById('currentUser');
    let currentUserObj = {};

    const boardTable = document.getElementById('boards');

    function uploadDataToPage() {
        token = localStorage.getItem('token');
        if (!token) {
            location.href = "/login";
        }

        Promise.all([uploadCurrentUserToPage()]).then(() => {
            uploadBoardsToPage();
        });
    }

    function uploadCurrentUserToPage() {
        return fetch(gateway_host + '/api/auth/current', {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: null
        })
            .then(response => response.json())
            .then(user => {
                const userLink = document.createElement("a");
                userLink.innerHTML = user.username;
                userLink.href = "/task-management/user/" + user.id;
                currentUser.appendChild(userLink);

                const logoutButton = document.createElement('button');
                logoutButton.innerHTML = "Logout";
                logoutButton.addEventListener('click', function () {
                    localStorage.removeItem('token');
                    location.href = "/login";
                });
                logoutButton.style.color = "blue";
                currentUser.appendChild(logoutButton);

                currentUserObj = user;
            })
            .catch(error => console.error(error));
    }

    function uploadBoardsToPage() {
        let count = 1;
        fetch(gateway_host + '/api/board?executorId=' + currentUserObj.id, {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: null
        })
            .then(response => response.json())
            .then(boards => boards.forEach(board => {
                const row = boardTable.insertRow();

                row.insertCell(0).innerText = count;
                row.insertCell(1).innerText = board.owner.username;

                const boardCell = row.insertCell(2);
                const boardLink = document.createElement('a');
                boardLink.innerHTML = board.name;
                boardLink.href = "/task-management/board/" + board.id;
                boardCell.appendChild(boardLink);

                count++;
            }))
            .catch(error => {
                console.error(error);
                location.href = "/login";
            });
    }
</script>

</body>
</html>